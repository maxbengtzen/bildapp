<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gridprint</title>
    <link rel="icon" href="/el="manifest"meta name="theme-color" content="#00D3BB" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gridprint">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touchn.png
    <!-- Din bundlade CSS (t.ex. Tailwind/DaisyUI) -->
    <link rel="stylesheet" href="/class="min-h-dvh bg-base-100">
    <div class="min-h-dvh bg-base-100">
      <header class="pt-8 pb-4 text-center">
        <h1 class="text-3xl font-extrabold tracking-tight text-teal-700">Gridprint</h1>
        <p class="text-base-content/70 mt-1">Skapa utskrifts‑vänliga bildrutor i PDF.</p>
      </header>

      <main class="px-5">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="mx-auto max-w-md">
            <div class="card bg-base-200/60 backdrop-blur-md shadow-xl rounded-3xl">
              <div class="card-body space-y-5">
                <!-- Steg/överblick -->
                <ul class="steps w-full mb-2">
                  <li class="step step-primary">Storlek</li>
                  <li class="step">Bilder</li>
                  <li class="step">Skapa PDF</li>
                </ul>

                <!-- Bildstorlek -->
                <label class="form-control">
                  <div class="label">
                    <span class="label-text font-medium">Bildstorlek (cm)</span>
                    <div class="join hidden sm:inline-flex">
                      <button type="button" class="btn btn-xs join-item btn-outline" data-size="3">3</button>
                      <button type="button" class="btn btn-xs join-item btn-outline" data-size="5">5</button>
                      <button type="button" class="btn btn-xs join-item btn-outline" data-size="7">7</button>
                    </div>
                  </div>
                  <label class="input input-bordered flex items-center gap-2">
                    <input id="size" name="size" class="grow" type="number" step="0.1" value="5.5" placeholder="5.5" inputmode="decimal" aria-describedby="cellSizeHelp" />
                    <span class="opacity-60">cm</span>
                  </label>
                </label>

                <!-- Bilder (dropzone) -->
                <div class="form-control">
                  <div class="label"><span class="label-text font-medium">Bilder</span></div>
                  <label class="border-2 border-dashed rounded-2xl p-6 h-32 text-center cursor-pointer hover:bg-base-200 transition flex flex-col justify-center" for="fileInput">
                    <div class="text-base-content/70">
                      <span class="font-medium">Lägg till bilder</span> eller släpp dem här
                    </div>
                    <div class="text-xs opacity-70 mt-1">PNG/JPG/HEIC/HEIF • flera filer stöds</div>
                    <input id="fileInput" name="images" type="file" accept="image/*" multiple class="hidden" />
                  </label>
                  <!-- Thumbnails -->
                  <div id="thumbs" class="mt-3 grid grid-cols-5 gap-2"></div>
                  <div class="text-xs text-base-content/70 mt-1" id="imageCount">0 bilder valda</div>
                </div>

                <!-- Mini‑preview -->
                <div class="bg-base-100 rounded-2xl p-3 border">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium">Förhandsvisning</span>
                    <span class="text-xs text-base-content/70" id="dpiText">300 DPI</span>
                  </div>
                  <div class="aspect-[4/3] w-full bg-base-200 rounded-xl grid gap-1 p-1" id="previewGrid" style="grid-template-columns: repeat(5, 1fr);"></div>
                </div>

                <!-- CTA -->
                <button type="submit" class="btn btn-primary btn-lg rounded-2xl w-full" id="createBtn" disabled>
                  Skapa PDF
                </button>
                <p class="text-sm text-base-content/70 text-center">
                  PDF genereras <strong>på servern (Flask)</strong> i 300 DPI för skarp utskrift.
                </p>
                <p class="text-xs text-base-content/60 text-center">
                  Tips: iOS kan öppna PDF i ny flik i stället för automatisk nedladdning.
                </p>
              </div>
            </div>
          </div>
        </form>
      </main>
    </div>

    <script>
      // Endast systemtema (följ "prefers-color-scheme").
      function applyTheme(isDark) {
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      }
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark);
      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => applyTheme(e.matches));
      }

      // Elements
      const form = document.getElementById('uploadForm');
      const sizeInput = document.getElementById('size');
      const fileInput = document.getElementById('fileInput');
      const thumbs = document.getElementById('thumbs');
      const imageCount = document.getElementById('imageCount');
      const previewGrid = document.getElementById('previewGrid');
      const createBtn = document.getElementById('createBtn');
      const steps = document.querySelectorAll('.step');

      let selectedFiles = [];
      let objectUrls = [];

      function updateSteps() {
        steps.forEach((step, index) => {
          step.className = 'step';
          if (index === 0 && parseFloat(sizeInput.value) > 0) step.classList.add('step-primary');
          if (index === 1 && selectedFiles.length > 0) step.classList.add('step-primary');
          if (index === 2 && selectedFiles.length > 0) step.classList.add('step-primary');
        });
      }

      // Storleks-badges
      const sizeBadges = document.querySelectorAll('[data-size]');
      sizeBadges.forEach(badge => {
        badge.addEventListener('click', () => {
          sizeInput.value = badge.dataset.size;
          updatePreview();
          updateSteps();
        });
      });

      // File input + DnD
      fileInput.addEventListener('change', handleFiles);
      const dropzone = fileInput.parentElement;
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('bg-base-content/10');
      });
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('bg-base-content/10');
      });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('bg-base-content/10');
        const files = Array.from(e.dataTransfer.files);
        handleNewFiles(files);
      });

      function handleFiles(e) {
        const files = Array.from(e.target.files || []);
        handleNewFiles(files);
      }

      function handleNewFiles(files) {
        try {
          selectedFiles = [...selectedFiles, ...files.filter(f => f.type.startsWith('image/'))];
          renderThumbnails();
          updatePreview();
          updateSteps();
        } catch (err) {
          console.error('File handling error:', err);
          alert('Kunde inte lägga till filerna: ' + err.message);
        }
      }

      function renderThumbnails() {
        // Städa gamla objectURLs
        objectUrls.forEach(u => { try { URL.revokeObjectURL(u); } catch {} });
        objectUrls = [];

        thumbs.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const figure = document.createElement('figure');
          figure.className = 'relative';
          const img = document.createElement('img');
          const url = URL.createObjectURL(file);
          objectUrls.push(url);
          img.src = url;
          img.alt = file.name || 'bild';
          img.className = 'w-full h-12 object-cover rounded';
          const removeBtn = document.createElement('button');
          removeBtn.className = 'absolute top-0 right-0 btn btn-xs btn-circle btn-error';
          removeBtn.setAttribute('type', 'button');
          removeBtn.innerHTML = '×';
          removeBtn.addEventListener('click', () => removeFile(index));
          figure.appendChild(img);
          figure.appendChild(removeBtn);
          thumbs.appendChild(figure);
        });
        imageCount.textContent = `${selectedFiles.length} bilder valda`;
        createBtn.disabled = selectedFiles.length === 0;
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        renderThumbnails();
        updatePreview();
        updateSteps();
      }

      // Preview grid (A4 portrait): speglar backendlogik (storlek i cm -> pt)
      function updatePreview() {
        const size = Math.max(0.1, parseFloat(sizeInput.value) || 5.5);
        const paperWidthCm = 21.0;
        const paperHeightCm = 29.7;
        const cols = Math.max(1, Math.floor(paperWidthCm / size));
        const rows = Math.max(1, Math.floor(paperHeightCm / size));

        previewGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        previewGrid.innerHTML = '';
        for (let i = 0; i < cols * rows; i++) {
          const div = document.createElement('div');
          div.className = 'bg-base-100/80 rounded';
          previewGrid.appendChild(div);
        }
      }

      updatePreview();
      sizeInput.addEventListener('input', () => { updatePreview(); updateSteps(); });
      updateSteps();

      // Hjälpfunktion för busy state
      async function withBusy(btn, fn) {
        const oldHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Skapar...';
        try {
          return await fn();
        } finally {
          btn.innerHTML = oldHTML;
          btn.disabled = selectedFiles.length === 0;
        }
      }

      // Nedladdning med iOS-fallback
      function saveBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const isIOS = /iPad|iPhone|iPod/i.test(navigator.userAgent);
        if (isIOS) {
          // Öppna i ny flik
          window.open(url, '_blank');
          setTimeout(() => URL.revokeObjectURL(url), 10_000);
          return;
        }
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (selectedFiles.length === 0) {
          alert('Välj bilder först');
          return;
        }
        const sizeVal = Math.max(0.1, parseFloat(sizeInput.value) || 5.5);

        withBusy(createBtn, async () => {
          // Bygg FormData direkt från selectedFiles
          const data = new FormData();
          data.append('size', String(sizeVal));
          selectedFiles.forEach((file) => data.append('images', file, file.name));

          let res;
          try {
            res = await fetch('/upload', { method: 'POST', body: data });
          } catch (networkErr) {
            console.error('Fetch error:', networkErr);
            alert('Nätverksfel: ' + networkErr.message);
            return;
          }

          // Om servern svarar med HTML/text, visa fel
          const contentType = res.headers.get('Content-Type') || '';
          if (!res.ok) {
            const text = await res.text();
            console.error('Upload failed:', res.status, text);
            alert(`Fel ${res.status}: ${text}`);
            return;
          }
          if (!contentType.includes('application/pdf')) {
            // Kan hända vid felaktig SW-cache eller serverfel
            const text = await res.text();
            console.warn('Ov. innehållstyp, förväntade PDF. Svar:', text.slice(0, 500));
            alert('Servern returnerade inte en PDF. Kontrollera backend eller Service Worker.');
            return;
          }

          const blob = await res.blob();
          if (!blob || blob.size === 0) {
            alert('Tom PDF mottagen.');
            return;
          }

          saveBlob(blob, 'bilder.pdf');

          // Nollställ
          selectedFiles = [];
          renderThumbnails();
          updateSteps();
        });
      });

      // Registrera SW om den finns (se till att /sw.js inte cache:ar /upload)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(err => console.warn('SW registration failed:', err));
        });
      }
    </script>
  </body>
</html>
