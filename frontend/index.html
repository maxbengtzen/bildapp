<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gridprint</title>
    <link rel="icon" href="/favicon.svg" />

    <!-- PWA: web manifest and theme -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00D3BB" />

    <!-- iOS support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gridprint">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

    <link rel="stylesheet" href="/output.css">
  </head>
  <body class="min-h-dvh bg-base-100">
    <div class="min-h-dvh bg-base-100">
<header class="pt-8 pb-4 text-center">
<h1 class="text-3xl font-extrabold tracking-tight text-teal-700">Gridprint</h1>
<p class="text-base-content/70 mt-1">Skapa utskrifts‑vänliga bildrutor i PDF.</p>
</header>
<main class="px-5">
<div class="mx-auto max-w-md">
<div class="card bg-base-200/60 backdrop-blur-md shadow-xl rounded-3xl">
<div class="card-body space-y-5">
<!-- Steg/överblick -->
<ul class="steps w-full mb-2">
<li class="step step-primary">Storlek</li>
<li class="step">Bilder</li>
<li class="step">Skapa PDF</li>
</ul>
<!-- Rutstorlek -->
<label class="form-control">
<div class="label">
<span class="label-text font-medium">Rutstorlek (cm)</span>
<div class="join hidden sm:inline-flex">
<button type="button" class="btn btn-xs join-item btn-outline" data-size="3">3</button>
<button type="button" class="btn btn-xs join-item btn-outline" data-size="5">5</button>
<button type="button" class="btn btn-xs join-item btn-outline" data-size="7">7</button>
</div>
</div>
<label class="input input-bordered flex items-center gap-2">
<input id="size" name="size" class="grow" type="number" step="0.1" value="5.5" placeholder="5.5" inputmode="decimal" aria-describedby="cellSizeHelp" />
<span class="opacity-60">cm</span>
</label>
<div id="cellSizeHelp" class="label">
<span class="label-text-alt text-base-content/70 break-all">
Större värde ⇒ färre rutor per sida. Ex: 5,0 cm ≈ 20 rutor på A4.
</span>
</div>
</label>

<!-- Bilder (dropzone) -->
<div class="form-control">
<div class="label"><span class="label-text font-medium">Bilder</span></div>
<label class="border-2 border-dashed rounded-2xl p-6 h-32 text-center cursor-pointer hover:bg-base-200 transition flex flex-col justify-center" for="fileInput">
<div class="text-base-content/70">
<span class="font-medium">Lägg till bilder</span> eller släpp dem här
</div>
<div class="text-xs opacity-70 mt-1">PNG/JPG • flera filer stöds</div>
<input id="fileInput" name="images" type="file" accept="image/*" multiple class="hidden" />
</label>
<!-- Thumbnails -->
<div id="thumbs" class="mt-3 grid grid-cols-5 gap-2">
</div>
<div class="text-xs text-base-content/70 mt-1" id="imageCount">0 bilder valda</div>
</div>
<!-- Mini‑preview -->
<div class="bg-base-100 rounded-2xl p-3 border">
<div class="flex items-center justify-between mb-2">
<span class="text-sm font-medium">Förhandsvisning</span>
<span class="text-xs text-base-content/70" id="dpiText">300 DPI</span>
</div>
<div class="aspect-[4/3] w-full bg-base-200 rounded-xl grid gap-1 p-1" id="previewGrid" style="grid-template-columns: repeat(5, 1fr);">
<!-- Dynamiskt genererat -->
</div>
</div>
<!-- CTA -->
<button class="btn btn-primary btn-lg rounded-2xl w-full" id="createBtn" disabled>
Skapa PDF
</button>
<p class="text-sm text-base-content/70 text-center">
PDF genereras lokalt i webbläsaren i 300 DPI för skarp utskrift.
</p>
</div>
</div>
</div>
</main>
</div>

    <script>
      // Apply system theme only (no UI toggle). Uses prefers-color-scheme and keeps in sync.
      function applyTheme(isDark) {
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      }

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark);

      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          applyTheme(e.matches);
        });
      }

      // Elements
      const form = document.getElementById('uploadForm');
      const sizeInput = document.getElementById('size');
      const fileInput = document.getElementById('fileInput');
      const thumbs = document.getElementById('thumbs');
      const imageCount = document.getElementById('imageCount');
      const previewGrid = document.getElementById('previewGrid');
      const createBtn = document.getElementById('createBtn');
      const steps = document.querySelectorAll('.step');

      let selectedFiles = [];

      function updateSteps() {
        steps.forEach((step, index) => {
          step.className = 'step';
          if (index === 0 && parseFloat(sizeInput.value) > 0) step.classList.add('step-primary');
          if (index === 1 && selectedFiles.length > 0) step.classList.add('step-primary');
          if (index === 2 && selectedFiles.length > 0) step.classList.add('step-primary');
        });
      }

      // Size badges
      const sizeBadges = document.querySelectorAll('[data-size]');
      sizeBadges.forEach(badge => {
        badge.addEventListener('click', () => {
          sizeInput.value = badge.dataset.size;
          updatePreview();
          updateSteps();
        });
      });

      // File input events
      fileInput.addEventListener('change', handleFiles);
      // Drag and drop
      const dropzone = fileInput.parentElement;
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('bg-base-content/10');
      });
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('bg-base-content/10');
      });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('bg-base-content/10');
        const files = Array.from(e.dataTransfer.files);
        handleNewFiles(files);
      });

      function handleFiles(e) {
        const files = Array.from(e.target.files);
        handleNewFiles(files);
      }

      function handleNewFiles(files) {
        selectedFiles = [...selectedFiles, ...files.filter(f => f.type.startsWith('image/'))];
        fileInput.files = new DataTransfer().files; // Reset for next selection
        renderThumbnails();
        updatePreview();
        updateSteps();
      }

      function renderThumbnails() {
        thumbs.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const figure = document.createElement('figure');
          figure.className = 'relative';
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.className = 'w-full h-12 object-cover rounded';
          const removeBtn = document.createElement('button');
          removeBtn.className = 'absolute top-0 right-0 btn btn-xs btn-circle btn-error';
          removeBtn.innerHTML = '×';
          removeBtn.addEventListener('click', () => removeFile(index));
          figure.appendChild(img);
          figure.appendChild(removeBtn);
          thumbs.appendChild(figure);
        });
        imageCount.textContent = `${selectedFiles.length} bilder valda`;
        createBtn.disabled = selectedFiles.length === 0;
      }

      function removeFile(index) {
        URL.revokeObjectURL(selectedFiles[index]);
        selectedFiles.splice(index, 1);
        renderThumbnails();
        updatePreview();
      }

      // Preview grid (A4 Portrait only)
      function updatePreview() {
        const size = parseFloat(sizeInput.value) || 5.5;
        const paperWidth = 21; // A4 portrait width cm
        const paperHeight = 29.7; // A4 portrait height cm
        let cols = Math.max(1, Math.floor(paperWidth / size));
        let rows = Math.max(1, Math.floor(paperHeight / size));
        previewGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        previewGrid.innerHTML = '';
        for (let i = 0; i < cols * rows; i++) {
          const div = document.createElement('div');
          div.className = 'bg-base-100/80 rounded';
          previewGrid.appendChild(div);
        }
      }

      // Initial
      updatePreview();
      sizeInput.addEventListener('input', () => { updatePreview(); updateSteps(); });
      updateSteps();

      // Upload form
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (selectedFiles.length === 0) {
          alert('Välj bilder först');
          return;
        }
        console.log('Sending data with size:', sizeInput.value, 'files:', selectedFiles.length);
        // Populate fileInput with selectedFiles for FormData
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        const data = new FormData(form);
        try {
          const res = await fetch('/upload', { method: 'POST', body: data });
          console.log('Response status:', res.status, 'OK:', res.ok);
          if (!res.ok) {
            const errorText = await res.text();
            console.error('Upload failed with response:', errorText);
            alert('Upload failed: ' + errorText);
            return;
          }
          const blob = await res.blob();
          console.log('Blob received, size:', blob.size);
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'bilder.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          // Clear after submit
          selectedFiles = [];
          renderThumbnails();
          updateSteps();
        } catch (error) {
          console.error('Fetch error:', error);
          alert('Network error: ' + error.message);
        }
      });

      // Register service worker for PWA (if supported)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .catch(err => console.warn('SW registration failed:', err));
        });
      }
    </script>
  </body>
</html>
